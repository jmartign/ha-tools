#!/bin/sh
#
# A tool to administer OCF resources directly.
#
# http://github.com/joekhoobyar/ha-tools
#
# Author:		Joe Khoobyar <joe@ankhcraft.com>
# License:	GNU General Public License (GPL) version 2
# Copyright (c) 2009 All Rights Reserved
#

version=0.1
progname=$(basename $0)

print_usage() {
    cat <<EOF
Usage: $progname resource-agent [options] command [resource-id]

A tool to deal with errors in the CIB.

Resource Agent:

  A fully-qualified resource agent name, such as: heartbeat/IPaddr2

Options:
  -h, --help          print this usage message
  -V, --version       print program version
  -v, --verbose       verbose output
  -p, --param         OCF parameters, in the form:  "name value"

Commands:

  -M, --metadata      display the resource agent's metadata
  -m, --monitor       monitor the resource
  -s, --status        check the resource's status, a la an LSB initscript
EOF
}

print_version()
{
    cat <<EOF
$progname (ha-tools) $version
Copyright (C) 2009 All Rights Reserved
Written by Joe Khoobyar <joe@ankhcraft.com>
EOF
}

agent="$1"
shift
if [ -z "$agent" ]; then print_usage; exit 1; fi

SHORTOPTS="hVvp:Mms"
LONGOPTS="help,version,verbose,param,metadata,monitor,status"
if $(getopt -T >/dev/null 2>&1) ; [ $? = 4 ] ; then # New longopts getopt.
    OPTS=$(getopt -o $SHORTOPTS --long $LONGOPTS -n "$progname" -- "$@")
else
    case $1 in --help) print_usage; exit 0 ;; esac
    case $1 in --version) print_version ; exit 0 ;; esac
    OPTS=$(getopt $SHORTOPTS "$@")
fi 

[ "$OPTS" = " --" ] && OPTS=" -h --"

eval set -- "${OPTS}"

: ${OCF_ROOT:=/usr/lib/ocf}
OCF_BIN=$OCF_ROOT/resource.d
export OCF_ROOT

agent_bin="$OCF_BIN/$agent"
if ! [ -x "$agent_bin" ]; then print_usage; exit 1; fi

while [ $# -gt 0 ]; do
case $1 in
  -h|--help)
    print_usage; exit 0
    ;;
  -V|--version)
    print_version; exit 0
    ;;
  -v|--verbose)
    export VERBOSE=1; shift
    ;;
  -M|--metadata)
		env $agent_args $agent_bin meta-data; shift
  	;;
  -m|--monitor)
		env $agent_args OCF_RESOURCE_INSTANCE="$2" $agent_bin monitor; shift 2
  	;;
  -s|--status)
		env $agent_args OCF_RESOURCE_INSTANCE="$2" $agent_bin status; shift 2
  	;;
  -p|--param)
		agent_args="OCF_RESKEY_${2%% *}=${2#* } "; shift 2
  	;;
  --)
    shift
    break
    ;;
  *)
    echo "Internal Error: option processing error: $1" 1>&2
    exit 1
    ;;
esac
shift
done

